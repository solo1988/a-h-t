{% extends "v2/base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –ù–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å{% endblock %}

{% block install_button %}

<button id="install-btn"
        style="display: none; position: fixed; bottom: 16px; right: 16px; padding: 10px 16px; z-index: 9999;">
    üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
</button>{% endblock %}

{% block content %}


<div class="d-flex align-items-center justify-content-between my-4">
    <h3 class="text-center flex-shrink-0 mb-0">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}!</h3>
    <input type="text" class="form-control search-input flex-grow-1 ms-4" placeholder="–ü–æ–∏—Å–∫" id="searchInput">
</div>

<div class="mb-3">
    <div id="search-overlay-new" class="d-none">
        <div data-bs-theme="dark">
            <button type="button" class="btn-close" id="close-search" aria-label="Close"></button>
        </div>
        <div data-bs-theme="dark" id="search-results" class="list-group my-4"
             style="max-height: 300px; overflow-y: auto;"></div>
    </div>
    <button class="btn btn-outline-warning me-2" id="showArchiveBtn">
        <i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤
    </button>
    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#logsModal">
        <i class="bi bi-journal-text"></i> –õ–æ–≥–∏
    </button>
</div>

<div id="gameList">
    {% for game in games %}
    {% set earned = game.earned_achievements %}
    {% set total = game.total_achievements %}
    {% set percent = (earned / total * 100) if total > 0 else 0 %}
    {% set is_platinum = earned == total and total > 0 %}
    <div class="game-card my-4 d-flex align-items-stretch {% if is_platinum %}platinum{% endif %} {% if game.is_archived %}d-none{% endif %}"
         data-game-name="{{ game.name | lower }}" data-appid="{{ game.appid }}">
        <img src="{{ game.background or 'https://via.placeholder.com/64' }}" alt="{{ game.name }}">
        <div class="ms-2 flex-grow-1 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center pt-0">
                <span class="small">
                    {{ game.name }}
                    {% if is_platinum %}
                        <i class="bi bi-award-fill text-warning" title="–ü–ª–∞—Ç–∏–Ω–æ–≤–∞—è –∏–≥—Ä–∞"></i>
                    {% endif %}
                </span>
                <span class="small">{{ earned }}/{{ total }}</span>
            </div>
            <div class="progress">
                <div class="progress-bar {% if is_platinum %}bg-warning{% else %}bg-success{% endif %}"
                     role="progressbar" style="width: {{ percent }}%;"></div>
            </div>
            <div class="mt-1">
                {% if game.appid %}
                <a href="/achievements/{{ game.appid }}" class="btn btn-outline-light me-2" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">–î–µ—Ç–∞–ª–∏</a>
                {% endif %}
                <button class="btn btn-outline-danger archive-btn" style="--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;" data-appid="{{ game.appid }}">–ê—Ä—Ö–∏–≤</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞—Ä—Ö–∏–≤–∞ -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="archiveList">
                <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞...</p>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–æ–≤ -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">–õ–æ–≥–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">

                <!-- Tabs nav -->
                <ul class="nav nav-tabs" id="logTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="app-tab" data-bs-toggle="tab" data-bs-target="#app-log"
                                type="button" role="tab" aria-controls="app-log" aria-selected="true">app.log
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="releases-tab" data-bs-toggle="tab"
                                data-bs-target="#releases-log"
                                type="button" role="tab" aria-controls="releases-log" aria-selected="false">
                            releases.log
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="updater-tab" data-bs-toggle="tab" data-bs-target="#updater-log"
                                type="button" role="tab" aria-controls="updater-log" aria-selected="false">
                            updater.log
                        </button>
                    </li>
                </ul>

                <!-- Tabs content -->
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="app-log" role="tabpanel" aria-labelledby="app-tab">
                            <pre id="appLogContent" class="bg-dark text-white p-3 rounded"
                                 style="max-height: 600px; overflow-y: auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                    </div>
                    <div class="tab-pane fade" id="releases-log" role="tabpanel" aria-labelledby="releases-tab">
                            <pre id="releasesLogContent" class="bg-dark text-white p-3 rounded"
                                 style="max-height: 600px; overflow-y: auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                    </div>
                    <div class="tab-pane fade" id="updater-log" role="tabpanel" aria-labelledby="updater-tab">
                            <pre id="updaterLogContent" class="bg-dark text-white p-3 rounded"
                                 style="max-height: 600px; overflow-y: auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchBtn = document.getElementById('toggle-search');
        const searchOverlay = document.getElementById('search-overlay-new');
        const closeBtn = document.getElementById('close-search');
        const input = document.getElementById('searchInput');
        const results = document.getElementById('search-results');

        let timeout;

        function closeSearch() {
            searchOverlay.classList.remove('d-block');
            searchOverlay.classList.add('d-none');
            input.value = '';
            results.innerHTML = '';
        }

        closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            closeSearch();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSearch();
        });

        input.addEventListener('input', () => {
            clearTimeout(timeout);
            const query = input.value.trim();

            if (query.length < 2) {
                results.innerHTML = '';
                searchOverlay.classList.remove('d-block');
                searchOverlay.classList.add('d-none');
                return;
            } else {
                searchOverlay.classList.add('d-block');
                searchOverlay.classList.remove('d-none');
            }

            timeout = setTimeout(() => {
                fetch(`/api/search?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        results.innerHTML = '';
                        if (data.length) {
                            console.log(data);
                            data.forEach(rel => {
                                const a = document.createElement('a');
                                a.href = `/release/${rel.appid}`;
                                a.className = 'list-group-item list-group-item-action';
                                a.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <img src="/static/images/header/${rel.appid}.jpg" class="me-2" style="height: 40px;">
                                    <div>
                                        <div>${rel.name}</div>
                                        <small class="text-muted">${rel.release_date}</small>
                                    </div>
                                </div>`;
                                results.appendChild(a);
                            });
                        } else {
                            results.innerHTML = '<div class="list-group-item text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        }
                    });
            }, 300);
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function () {
            const filter = this.value.toLowerCase();
            document.querySelectorAll('#gameList .game-card').forEach(function (card) {
                card.style.display = card.dataset.gameName.includes(filter) ? '' : 'none';
            });
        });

// –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.querySelectorAll('.archive-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const appid = this.dataset.appid;
                fetch(`/archive/${appid}`, {method: 'POST'})
                    .then(res => {
                        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è");
                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
                        const card = this.closest('.game-card');
                        if (card) card.classList.add('d-none');
                    })
                    .catch(err => alert(err.message));
            });
        });

        // –ú–æ–¥–∞–ª–∫–∞ –∞—Ä—Ö–∏–≤–∞
        const archiveModal = new bootstrap.Modal(document.getElementById('archiveModal'));
        document.getElementById('showArchiveBtn').addEventListener('click', () => {
            archiveModal.show();
            fetch("/archived")
                .then(res => res.json())
                .then(games => {
                    const container = document.getElementById("archiveList");
                    container.innerHTML = "";
                    if (games.length === 0) {
                        container.innerHTML = "<p class='text-muted'>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>";
                        return;
                    }
                    games.forEach(game => {
                        console.log(game);
                        container.innerHTML += `
                        <div class="game-card my-3 d-flex align-items-center" data-appid="${game.appid}">
                            <img src="${game.background || 'https://via.placeholder.com/64'}" alt="${game.name}">
                            <div class="ms-3 flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>${game.name}</span>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-success restore-btn" data-appid="${game.appid}">–í–µ—Ä–Ω—É—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    `;
                    });

// –ö–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞
                    container.querySelectorAll('.restore-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const appid = this.dataset.appid;
                            fetch(`/unarchive/${appid}`, {method: 'POST'})
                                .then(res => {
                                    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞");
                                    // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –æ—Ñ—Ñ–∫–∞–Ω–≤–∞—Å–∞ –∞—Ä—Ö–∏–≤–∞
                                    this.closest('.game-card').remove();
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
                                    const mainCard = document.querySelector(`.game-card[data-appid="${appid}"]`);
                                    if (mainCard) mainCard.classList.remove('d-none');
                                })
                                .catch(err => alert(err.message));
                        });
                    });
                })
                .catch(() => {
                    document.getElementById("archiveList").innerHTML = "<p class='text-danger'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞.</p>";
                });
        });

        // –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–æ–≤
        const logModal = document.getElementById('logsModal');
        const logMap = {
            'app-tab': {path: '/log/app', target: 'appLogContent'},
            'releases-tab': {path: '/log/releases', target: 'releasesLogContent'},
            'updater-tab': {path: '/log/updater', target: 'updaterLogContent'}
        };

        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –ª–æ–≥
        logModal.addEventListener('show.bs.modal', () => {
            loadLog('app-tab');
        });

        // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ª–æ–≥–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        Object.keys(logMap).forEach(tabId => {
            document.getElementById(tabId).addEventListener('click', () => {
                loadLog(tabId);
            });
        });

        function loadLog(tabId) {
            const logInfo = logMap[tabId];
            const target = document.getElementById(logInfo.target);
            target.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            fetch(logInfo.path)
                .then(response => response.text())
                .then(text => {
                    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –∏ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                    const lines = text.split('\n').reverse();
                    target.textContent = lines.join('\n');
                })
                .catch(() => {
                    target.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥.';
                });
        }
    });
</script>
{% endblock %}
{% block install_scripts %}
<script src="/static/install.js"></script>
<script src="/static/subscription.js?v=1"></script>{% endblock %}
