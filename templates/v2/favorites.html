{% extends "v2/base.html" %}

{% block title %}Избранные игры — {{ user.username }}{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between my-4">
    <h3 class="mb-0">Избранные игры: {{ user.username }}</h3>
    <input type="text" class="form-control search-input w-50 ms-4" placeholder="Поиск игр" id="searchFavorites">
</div>

{% if releases %}
<div id="favoritesContainer">
    <h5 class="mt-3">Уже вышли</h5>
    <div class="row g-3 mb-4" id="released"></div>

    <h5 class="mt-3">Ожидают релиза</h5>
    <div class="row g-3" id="upcoming"></div>

    {% for rel in releases %}
    <div class="col-6 col-md-4 col-lg-3 release-card" data-release-date="{{ rel.release_date|default('') }}">
        <div class="card h-100 bg-dark text-white border position-relative">
            <img src="/static/images/header/{{ rel.appid }}.jpg" class="card-img-top" alt="{{ rel.name }}">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title">{{ rel.name }}</h6>
                <a href="/release/{{ rel.appid }}" class="stretched-link mt-auto"></a>
            </div>
            <span class="badge bg-danger position-absolute top-100 start-50 translate-middle">
                {% if rel.release_date %}
                    {% if rel.release_date.lower() == 'coming soon' or rel.release_date.lower() == 'скоро выйдет' %}
                        Скоро выйдет
                    {% else %}
                        {{ rel.release_date }}
                    {% endif %}
                {% else %}
                    Дата не указана
                {% endif %}
            </span>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>У вас пока нет избранных игр.</p>
{% endif %}
{% endblock %}

{% block included_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const MONTHS_RU = {
            'янв': 0, 'фев': 1, 'февр': 1, 'мар': 2, 'апр': 3, 'май': 4, 'мая': 4,
            'июн': 5, 'июл': 6, 'авг': 7, 'сен': 8, 'сент': 8, 'окт': 9, 'ноя': 10, 'нояб': 10, 'дек': 11
        };

        function parseReleaseDate(dateStr) {
            if (!dateStr) return new Date('2300-01-01');
            let clean = dateStr.toLowerCase().trim().replace(/\s*г\.?$/, '');
            if (clean === 'coming soon' || clean === 'скоро выйдет') return new Date('2200-01-01');
            if (clean === 'ещё не объявлена' || clean === 'еще не объявлена') return new Date('2250-01-01');
            if (/^\d{4}$/.test(clean)) return new Date(`${clean}-12-31`);
            const parts = clean.split(/\s+/);
            if (parts.length === 3) {
                let [day, monthStr, year] = parts.map(p => p.trim());
                day = parseInt(day);
                year = parseInt(year);
                const month = MONTHS_RU[monthStr.replace(/\./g, '')];
                if (month === undefined) return new Date('2300-01-01');
                return new Date(year, month, day);
            }
            return new Date('2300-01-01');
        }

        const container = document.querySelector('#favoritesContainer');
        if (!container) return;
        const releasedContainer = container.querySelector('#released');
        const upcomingContainer = container.querySelector('#upcoming');

        const cards = Array.from(container.querySelectorAll('.release-card'));
        cards.sort((a, b) => parseReleaseDate(a.dataset.releaseDate) - parseReleaseDate(b.dataset.releaseDate));

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        cards.forEach(card => {
            const releaseDate = parseReleaseDate(card.dataset.releaseDate);
            if (releaseDate <= today) releasedContainer.appendChild(card);
            else upcomingContainer.appendChild(card);
        });

        // Поиск по названию
        const searchInput = document.getElementById('searchFavorites');
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            cards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                card.style.display = title.includes(query) ? 'block' : 'none';
            });
        });

        const releases = Array.from(document.querySelectorAll('.release-card')).map(card => ({
            name: card.querySelector('.card-title')?.textContent || null,
            release_date: card.dataset.releaseDate || null,
            href: card.querySelector('.stretched-link').href || null,
        }));
        console.log(releases);
    });
</script>
{% endblock %}
