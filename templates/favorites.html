{% extends "base.html" %}

{% block title %}Избранные игры — {{ user.username }}{% endblock %}

{% block white_bg %}
<div class="white-tint"></div>
{% endblock %}

{% block content %}
<h1 class="mb-4">Избранные игры пользователя {{ user.username }}</h1>
<div class="d-grid gap-2 d-md-flex justify-content-md-between">
    <a href="/last_releases" class="btn btn-primary mb-5 mt-1">Последние обновления</a>
    <a href="/wanted" class="btn btn-primary mb-5 mt-1">Самые ожидаемые игры года</a>
</div>
{% if releases %}
<div class="row" id="releases-div">
    <h3>Уже вышли</h3>
    <div id="released" class="row"></div>

    <h3 class="mt-4">Ожидают релиза</h3>
    <div id="upcoming" class="row"></div>
    {% for rel in releases %}
    <div class="col-md-4 col-sm-6 my-3 release-card" data-release-date="{{ rel.release_date|default('') }}">
        <div class="card h-100 position-relative">
            <img src="/static/images/header/{{ rel.appid }}.jpg"
                 class="card-img-top" alt="{{ rel.name }}">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title">{{ rel.name }}</h6>
                <a href="/release/{{ rel.appid }}" class="mt-auto stretched-link"></a>
            </div>
            <span class="position-absolute top-100 start-50 translate-middle badge rounded-pill bg-danger">
                {% if rel.release_date %}
                    {% if rel.release_date.lower() == 'coming soon' or rel.release_date.lower() == 'скоро выйдет' %}
                        Дата релиза: Скоро выйдет
                    {% else %}
                        Дата релиза: {{ rel.release_date }}
                    {% endif %}
                {% else %}
                    Дата релиза не указана
                {% endif %}
            </span>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>У вас пока нет избранных игр.</p>
{% endif %}
{% endblock %}

{% block included_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
    const MONTHS_RU = {
        'янв': 0,
        'фев': 1, 'февр': 1,
        'мар': 2,
        'апр': 3,
        'май': 4, 'мая': 4,
        'июн': 5,
        'июл': 6,
        'авг': 7,
        'сен': 8, 'сент': 8,
        'окт': 9,
        'ноя': 10, 'нояб': 10,
        'дек': 11
    };

    function parseReleaseDate(dateStr) {
        if (!dateStr) return new Date('2300-01-01');

        let clean = dateStr.toLowerCase().trim();

        clean = clean.replace(/\s*г\.?$/, '').trim();

        if (clean === 'coming soon' || clean === 'скоро выйдет') return new Date('2200-01-01');
        if (clean === 'ещё не объявлена' || clean === 'еще не объявлена') return new Date('2250-01-01');

        if (/^\d{4}$/.test(clean)) {
            return new Date(`${clean}-12-31`);
        }

        const parts = clean.split(/\s+/);

        if (parts.length === 3) {
            let [day, monthStr, year] = parts;
            day = parseInt(day);
            year = parseInt(year);

            monthStr = monthStr.replace(/\./g, '').trim();

            const month = MONTHS_RU[monthStr];
            if (month === undefined) {
                console.warn('Unknown month:', monthStr, 'in date:', dateStr);
                return new Date('2300-01-01');
            }
            return new Date(year, month, day);
        }

        console.warn('Unknown format for "' + dateStr + '", assigning max date');
        return new Date('2300-01-01');
    }

    const container = document.querySelector('#releases-div');
    if (!container) return;

    const releasedContainer = container.querySelector('#released');
    const upcomingContainer = container.querySelector('#upcoming');

    const cards = Array.from(container.querySelectorAll('.release-card'));

    cards.sort((a, b) => {
        const aDate = parseReleaseDate(a.dataset.releaseDate);
        const bDate = parseReleaseDate(b.dataset.releaseDate);

        return aDate - bDate;
    });

    const today = new Date();
    today.setHours(0,0,0,0);  // обнуляем время для сравнения только по дате

    cards.forEach(card => {
        const releaseDate = parseReleaseDate(card.dataset.releaseDate);
        if (releaseDate <= today) {
            releasedContainer.appendChild(card);
        } else {
            upcomingContainer.appendChild(card);
        }
    });
});

</script>
{% endblock %}
