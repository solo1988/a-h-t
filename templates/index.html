<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä—ã</title>
    <link rel="shortcut icon" href="/static/favicon.ico">
    <link rel="manifest" href="/static/manifest.json?v=4">
    <meta name="theme-color" content="#000000">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/main.css">
</head>
<body>
<div class="background-overlay"></div>
<button id="install-btn"
        style="display: none; position: fixed; bottom: 16px; right: 16px; padding: 10px 16px; z-index: 9999;">
    üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
</button>
<h1 class="text-center mt-4">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}!</h1>
<div id="app-container">
    <div class="container mt-5">
        <div class="container p-0 mt-4">
            <form id="addGameForm">
		<div class="form-floating mb-3 input-group">
                    <input type="number" id="appidInput" class="form-control" required="" placeholder="12345678">
                    <label for="appidInput">–í–≤–µ–¥–∏—Ç–µ AppID –∏–≥—Ä—ã:</label>
		    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É</button>
                </div>
            </form>
        </div>
        <div class="row">
            {% for game in games %}
            <div class="col-md-4 my-3">
                <div class="card d-flex flex-column h-100 border-0">
		    <img class="card-img" src="{{ game.background }}">
                    <div class="card-img-overlay p-0 d-flex flex-column">
			<a href="/achievements/{{ game.appid }}" class="stretched-link"></a>
                        {% set earned = game.earned_achievements %}
                        {% set total = game.total_achievements %}
                        {% set percent = (earned / total * 100) if total > 0 else 0 %}
                        <p class="card-text py-2 bg-dark bg-opacity-75 text-white text-center mt-auto rounded">
                           <strong>–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {{ earned }} –∏–∑ {{ total }} ({{ percent|round(0, 'floor') }}% –ø–æ–ª—É—á–µ–Ω–æ)</strong>
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script src="/static/install.js"></script>
    <script>
        document.getElementById("addGameForm").addEventListener("submit", async function (event) {
            event.preventDefault();  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

            let appid = document.getElementById("appidInput").value.trim();  // –ü–æ–ª—É—á–∞–µ–º appid
            console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º appid:", appid);  // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

            let response = await fetch("/add_game", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({appid: appid}),
            });

            let result = await response.json();
            if (response.ok) {
                alert("–ò–≥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + JSON.stringify(result));  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            }
        });
        const VAPID_PUBLIC_KEY = "BPbVTP_DQbdgTrMuOi4GW6eQ8F5vVezzxsAYQZs1_cjTEF079H3EqgeOvhiSD7ZxgBzS5EoFT2nRrGX5Z3AOZ2I";  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á

        document.addEventListener("DOMContentLoaded", function () {
            if ("serviceWorker" in navigator) {
                const version = Date.now();  // üëà –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
                navigator.serviceWorker.register(`/static/sw.js?v=${version}`)
                    .then((reg) => {
                        console.log("Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ —Ñ—Ä–æ–Ω—Ç–∞!", reg);
                        reg.update();  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–æ—Ä–∫–µ—Ä
                        initPushSubscription(reg);
                    })
                    .catch((err) => {
                        console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:", err);
                    });
            }
        });

        async function initPushSubscription(registration) {
            console.log("–ü—Ä–æ–±—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É");

            if (!("Notification" in window)) {
                console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è");
                return;
            }

            console.log("–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...");
            const permission = await Notification.requestPermission();
            console.log("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", permission);

            if (permission !== "granted") {
                console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è");
                return;
            }

            try {
                const existingSubscription = await registration.pushManager.getSubscription();
                console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏", existingSubscription);

                if (!existingSubscription) {
                    console.log("–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É...");
                    const newSubscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC_KEY)
                    });

                    const rawKeys = newSubscription.toJSON().keys;
                    const payload = {
                        endpoint: newSubscription.endpoint,
                        p256dh: rawKeys.p256dh,
                        auth: rawKeys.auth
                    };

                    console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", payload);
                    await sendSubscriptionToServer(payload);
                } else {
                    console.log("–£–∂–µ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞", existingSubscription);
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", err);
            }
        }

        async function sendSubscriptionToServer(subscription) {
            const response = await fetch('/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(subscription)
            });

            if (response.ok) {
                console.log("–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä");
            } else {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä", await response.text());
            }
        }

        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</div>
<script>
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ–∫–∞–∑ –±–∞–Ω–Ω–µ—Ä–∞
        deferredPrompt = e; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ
        document.getElementById('install-btn').style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
    });

    document.getElementById('install-btn').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            const choiceResult = await deferredPrompt.userChoice;
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:', choiceResult.outcome);
            deferredPrompt = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º
            document.getElementById('install-btn').style.display = 'none';
        }
    });
</script>
</body>
</html>
