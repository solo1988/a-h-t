{% extends "base.html" %}

{% block title %}–ò–≥—Ä—ã{% endblock %}

{% block install_button %}

{% block white_bg %}
<div class="white-tint"></div>{% endblock %}

<button id="install-btn"
        style="display: none; position: fixed; bottom: 16px; right: 16px; padding: 10px 16px; z-index: 9999;">
    üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
</button>{% endblock %}

{% block welcome %}<h1 class="text-center mt-5">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}!</h1>{% endblock %}
{% block log_button %}
<div class="text-end me-3">
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#logModal">
        üìÑ –õ–æ–≥
    </button>
    <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#archiveModal">
        üóÉÔ∏è –ê—Ä—Ö–∏–≤
    </button>
    <a href="/switch-ui" class="btn btn-outline-primary me-2">
        {% if request.cookies.get('use_v2') == '1' %}
        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        {% else %}
        –ù–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        {% endif %}
    </a>
</div>
{% endblock %}
{% block add_game %}
<form id="addGameForm">
    <div class="form-floating mb-3 input-group">
        <input type="number" id="appidInput" class="form-control" required="" placeholder="12345678">
        <label for="appidInput">–í–≤–µ–¥–∏—Ç–µ AppID –∏–≥—Ä—ã:</label>
        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É</button>
    </div>
</form>{% endblock %}

{% block content %}
<div class="row">
    {% for game in games %}
    {% set earned = game.earned_achievements %}
    {% set total = game.total_achievements %}
    {% set percent = (earned / total * 100) if total > 0 else 0 %}
    {% set border = 'border-5 border-warning' if percent > 99 else 'border-0' %}
    <div class="col-md-4 my-3 {% if game.is_archived %}d-none{% endif %}" data-appid="{{ game.appid }}">
        <div class="card d-flex flex-column h-100 {{border}} position-relative">
            <div class="position-absolute top-0 start-0 m-2" style="z-index: 2;">
                <button class="btn btn-sm btn-outline-light archive-btn position-relative"
                        data-appid="{{ game.appid }}"
                        title="–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É">
                    üóÑÔ∏è
                </button>
            </div>
            <div class="position-absolute top-0 start-100 translate-middle">
                {% if percent > 99 %}
                <i class="bi bi-star-fill fs-1 text-danger"></i>
                {% endif %}
            </div>
            <img class="card-img" src="{{ game.background }}">
            <div class="card-img-overlay p-0 d-flex flex-column">
                <a href="/achievements/{{ game.appid }}" class="stretched-link"></a>
                <p class="card-text py-2 bg-dark bg-opacity-75 text-white text-center mt-auto rounded">
                    {% if percent > 99 %}
                    <strong>–ü–õ–ê–¢–ò–ù–ê !!!</strong>
                    {% else %}
                    <strong>–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {{ earned }} –∏–∑ {{ total }} ({{ percent|round(0, 'floor') }}%
                        –ø–æ–ª—É—á–µ–Ω–æ)</strong>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">–õ–æ–≥–∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">

                    <!-- Tabs nav -->
                    <ul class="nav nav-tabs" id="logTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="app-tab" data-bs-toggle="tab" data-bs-target="#app-log"
                                    type="button" role="tab" aria-controls="app-log" aria-selected="true">app.log
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="releases-tab" data-bs-toggle="tab"
                                    data-bs-target="#releases-log"
                                    type="button" role="tab" aria-controls="releases-log" aria-selected="false">
                                releases.log
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="updater-tab" data-bs-toggle="tab" data-bs-target="#updater-log"
                                    type="button" role="tab" aria-controls="updater-log" aria-selected="false">
                                updater.log
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs content -->
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="app-log" role="tabpanel" aria-labelledby="app-tab">
                            <pre id="appLogContent" class="bg-dark text-white p-3 rounded"
                                 style="max-height: 600px; overflow-y: auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                        </div>
                        <div class="tab-pane fade" id="releases-log" role="tabpanel" aria-labelledby="releases-tab">
                            <pre id="releasesLogContent" class="bg-dark text-white p-3 rounded"
                                 style="max-height: 600px; overflow-y: auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                        </div>
                        <div class="tab-pane fade" id="updater-log" role="tabpanel" aria-labelledby="updater-tab">
                            <pre id="updaterLogContent" class="bg-dark text-white p-3 rounded"
                                 style="max-height: 600px; overflow-y: auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="archiveModalLabel">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div id="archivedGamesContainer" class="row">
                        <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>{% endblock %}
{% block included_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä—ã –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ ---
        document.querySelectorAll(".archive-btn").forEach(button => {
            button.addEventListener("click", function () {
                const appid = this.dataset.appid;
                fetch(`/archive/${appid}`, {method: "POST"})
                    .then(response => {
                        if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è");
                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        const card = this.closest(".col-md-4");
                        if (card) card.classList.add("d-none");
                    })
                    .catch(err => {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É: " + err.message);
                    });
            });
        });

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ ---
        const archiveModal = document.getElementById("archiveModal");
        archiveModal.addEventListener("show.bs.modal", function () {
            fetch("/archived")
                .then(response => response.json())
                .then(games => {
                    const container = document.getElementById("archivedGamesContainer");
                    container.innerHTML = "";

                    if (games.length === 0) {
                        container.innerHTML = "<p class='text-muted'>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>";
                        return;
                    }

                    games.forEach(game => {
                        const col = document.createElement("div");
                        col.className = "col-md-4 my-3";
                        col.innerHTML = `
                        <div class="card h-100 position-relative">
                            <img class="card-img" src="${game.background}" alt="">
                            <div class="card-img-overlay p-0 d-flex flex-column">
                                <a href="/achievements/${game.appid}" class="stretched-link"></a>
                                <button class="btn btn-sm btn-outline-light position-absolute top-0 start-0 m-2 restore-btn" data-appid="${game.appid}" style="z-index:2;">
                                    ‚ôªÔ∏è
                                </button>
                                <p class="card-text py-2 bg-dark bg-opacity-75 text-white text-center mt-auto rounded">
                                    <strong>${game.name}</strong>
                                </p>
                            </div>
                        </div>`;
                        container.appendChild(col);
                    });

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞
                    document.querySelectorAll(".restore-btn").forEach(button => {
                        button.addEventListener("click", function () {
                            const appid = this.dataset.appid;
                            fetch(`/unarchive/${appid}`, {method: "POST"})
                                .then(response => {
                                    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞");
                                    this.closest(".col-md-4").remove(); // –£–±–∏—Ä–∞–µ–º –∏–∑ –º–æ–¥–∞–ª–∫–∏ –∞—Ä—Ö–∏–≤–∞

                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                                    const mainCard = document.querySelector(`.col-md-4[data-appid="${appid}"]`);
                                    if (mainCard) mainCard.classList.remove("d-none");
                                })
                                .catch(err => {
                                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å –∏–≥—Ä—É –∏–∑ –∞—Ä—Ö–∏–≤–∞: " + err.message);
                                });
                        });
                    });
                })
                .catch(() => {
                    const container = document.getElementById("archivedGamesContainer");
                    container.innerHTML = "<p class='text-danger'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞.</p>";
                });
        });
    });
</script>
<script>
    document.getElementById("addGameForm").addEventListener("submit", async function (event) {
        event.preventDefault();  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

        let appid = document.getElementById("appidInput").value.trim();  // –ü–æ–ª—É—á–∞–µ–º appid
        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º appid:", appid);  // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

        let response = await fetch("/add_game", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({appid: appid}),
        });

        let result = await response.json();
        if (response.ok) {
            location.reload();  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        } else {
            alert("–û—à–∏–±–∫–∞: " + JSON.stringify(result));  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        }
    });
    document.addEventListener('DOMContentLoaded', function () {
        const logModal = document.getElementById('logModal');
        const logMap = {
            'app-tab': {path: '/log/app', target: 'appLogContent'},
            'releases-tab': {path: '/log/releases', target: 'releasesLogContent'},
            'updater-tab': {path: '/log/updater', target: 'updaterLogContent'}
        };

        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –ª–æ–≥
        logModal.addEventListener('show.bs.modal', () => {
            loadLog('app-tab');
        });

        // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ª–æ–≥–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        Object.keys(logMap).forEach(tabId => {
            document.getElementById(tabId).addEventListener('click', () => {
                loadLog(tabId);
            });
        });

        function loadLog(tabId) {
            const logInfo = logMap[tabId];
            const target = document.getElementById(logInfo.target);
            target.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            fetch(logInfo.path)
                .then(response => response.text())
                .then(text => {
                    target.textContent = text;
                })
                .catch(() => {
                    target.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥.';
                });
        }
    });
</script>
{% endblock %}
{% block install_scripts %}
<script src="/static/install.js"></script>
<script src="/static/subscription.js?v=2"></script>{% endblock %}